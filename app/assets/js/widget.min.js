var SITE_URL = "https://loanoptions.ai";

const params = new Proxy(new URLSearchParams(window.location.search), {
    get: (searchParams, prop) => searchParams.get(prop),
});
if (params.partnerId) {
    localStorage.setItem('externalPartnerId', params.partnerId);
} else {
    // SET DEFAULT DRIVE IQ PARTNER(REQUIRED)
    if (localStorage.getItem("externalPartnerId") === null) {
        localStorage.setItem('externalPartnerId', '1385');
    }
}

// HOST URL
localStorage.setItem('sourceUrl', 'https://loanoptions.ai');
// SOURCE NAME
localStorage.setItem('source', 'LOANOPTIONS');
// TARGET SYSTEM
localStorage.setItem('targetSystem', 'SKYNET');

var sourceval = localStorage.getItem("source");
var sourceUrl = localStorage.getItem("sourceUrl");
var externalPartnerId = localStorage.getItem("externalPartnerId");
var targetSystem = localStorage.getItem("targetSystem");

if (localStorage.getItem("quote") === null) {
    let quote = {
        type: "CAR_LOAN",
        usage: "CONSUMER",
        amount: "50000",
        term: "5",
        source: sourceval,
        sourceUrl: sourceUrl,
        targetSystem: targetSystem,
        externalPartnerId: externalPartnerId,
    }
    localStorage.setItem('quote', JSON.stringify(quote));
}

function generate(n) {
    var add = 1,
        max = 12 - add; // 12 is the min safe number Math.random() can generate without it starting to pad the end with zeros.   

    if (n > max) {
        return generate(max) + generate(n - max);
    }

    max = Math.pow(10, n + add);
    var min = max / 10; // Math.pow(10, n) basically
    var number = Math.floor(Math.random() * (max - min + 1)) + min;

    return ("" + number).substring(add);
}

var gid = generate(12);

if (localStorage.getItem("quoteId") === null) {
    if (localStorage.getItem("uid") === null) {
        localStorage.setItem("uid", gid);
    } else {

    }
} else {
    localStorage.setItem("uid", localStorage.getItem("quoteId"));
}

var slider = document.getElementById("borrowrange");
var output = document.getElementById("borrowtext");
output.value = slider.value;

slider.oninput = function () {
    output.value = slider.value;
}

function updateValue(e) {
    slider.value = e.target.value;
}

output.addEventListener('change', updateValue);

var yslider = document.getElementById("yearrange");
var youtput = document.getElementById("yeartext");
youtput.value = yslider.value;

yslider.oninput = function () {
    youtput.value = yslider.value;
}

function yupdateValue(e) {
    yslider.value = e.target.value;
}

youtput.addEventListener('change', yupdateValue);

// SET CSS PROPERTY
document.documentElement.style.setProperty('--widgetPrimary', '#5614BB');
document.documentElement.style.setProperty('--widgetSecondary', '#5614BB');
document.documentElement.style.setProperty('--widgetTertiary', '#5614BB');
document.documentElement.style.setProperty('--widgetQuaternary', '#f2f2f2');

jQuery(document).on("click", ".fieldgroupnext", function (e) {
    e.preventDefault();
    $(".fieldgroup").hide();
    $(".fieldgroup-2").fadeIn();
});

jQuery(document).on("click", ".fieldgroupnext-2", function (e) {
    e.preventDefault();
    $(".fieldgroup").hide();
    $(".fieldgroup-3").fadeIn();
});

jQuery(document).on("click", ".fieldgroupprev-2", function () {
    $(".fieldgroup").hide();
    $(".fieldgroup-1").fadeIn();
});

jQuery(document).on("click", ".fieldgroupprev-3", function () {
    $(".fieldgroup").hide();
    $(".fieldgroup-2").fadeIn();
});


// General 
function loansubmit(typeval, usageval) {
    var amount = $("#borrowtext").val();
    var year = $("#yeartext").val();
    var sourceval = 'LOANOPTIONS';
    var sourceUrl = 'https://shopforcars.aiims-staging.com.au';
    var externalPartnerId = '1385';
    var targetSystem = 'SKYNET';

    let quote = {
        type: typeval,
        usage: usageval,
        amount: amount,
        term: year,
        source: sourceval,
        sourceUrl: sourceUrl,
        targetSystem: targetSystem,
        externalPartnerId: externalPartnerId,
    }

    localStorage.setItem('quote', JSON.stringify(quote));
}

function redirectapplication() {
    let newTab = window.open();
    newTab.location.href = SITE_URL + '/application';
}

// Car Loan
function carloansubmitquote() {
    var type = $("#loantype").val();
    var loantype = (type == "Business") ? 'COMMERCIAL_FULL_DOC' : 'CONSUMER';
    return Array("CAR_LOAN", loantype);
}

if ($(".loanwidgetsubmit").length > 0) {
    var arr = carloansubmitquote();
    var typeval = arr[0];
    var usageval = arr[1];
    loansubmit(typeval, usageval);
}

jQuery(document).on("click", ".loanwidgetsubmit", function () {
    var arr = carloansubmitquote();
    var typeval = arr[0];
    var usageval = arr[1];
    loansubmit(typeval, usageval);
    redirectapplication();
});
